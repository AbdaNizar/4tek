import{b as g}from"./chunk-HWLEWUSP.js";import{T as p,Z as h,e as n,ra as c}from"./chunk-72X2LRK3.js";var m=class u{http=h(g);CLIENT_URL="http://localhost:4200";API_URL="http://localhost:3000/v1";CLIENT_ORIGIN=new URL(this.CLIENT_URL).origin;token=c(localStorage.getItem("auth_token"));user=c(JSON.parse(localStorage.getItem("auth_user")||"null"));hydrateFromStorage(){return n(this,null,function*(){if(this.token())try{let t=yield this.http.get(`${this.API_URL}/auth/me`).toPromise();t&&(this.user.set(t),localStorage.setItem("auth_user",JSON.stringify(t)))}catch{this.logout()}})}login(t,e){return n(this,null,function*(){let s=yield this.http.post(`${this.API_URL}/auth/login`,{email:t,password:e}).toPromise();if(!s)throw new Error("R\xE9ponse vide");if(console.log(s.user.isVerified),!s.user.isVerified)throw new Error("Email non v\xE9rifi\xE9. V\xE9rifie ta bo\xEEte mail ou renvoie l\u2019email de confirmation.");if(!s.user.active)throw new Error("Votre compte est actuellement bloqu\xE9 par l'administrateur. Nous vous prions de contacter le support technique.");return this.applyLogin(s),!0})}register(t){return n(this,null,function*(){let e=yield this.http.post(`${this.API_URL}/auth/register`,t).toPromise();return e?.token&&this.applyLogin(e),!!e?.token})}forgotPassword(t){return n(this,null,function*(){console.log(t),yield this.http.post(`${this.API_URL}/auth/forgot/password`,{email:t}).toPromise()})}resetPassword(t,e){return n(this,null,function*(){yield this.http.post(`${this.API_URL}/auth/reset`,{token:t,password:e}).toPromise()})}resendVerification(t){return n(this,null,function*(){console.log("email ",t),yield this.http.post(`${this.API_URL}/auth/resend-verification`,{email:t}).toPromise()})}handleAuthHash(){return n(this,null,function*(){let e=(window.location.hash||"").match(/#data=([^&]+)/);if(!e)return null;history.replaceState({},document.title,window.location.pathname+window.location.search);try{let s=atob(e[1].replace(/-/g,"+").replace(/_/g,"/")),o=JSON.parse(s);switch(o?.type){case"VERIFY_OK":return o?.token&&o?.user&&this.applyLogin({token:o.token,user:o.user}),{type:"VERIFY_OK"};case"EMAIL_VALID":return{type:"EMAIL_VALID",email:o?.email};case"VERIFY_EXPIRED":return{type:"VERIFY_EXPIRED",email:o?.email};case"VERIFY_INVALID":return{type:"VERIFY_INVALID",email:o?.email};default:return null}}catch{return null}})}logout(){this.token.set(null),this.user.set(null),localStorage.removeItem("auth_token"),localStorage.removeItem("auth_user")}isLoggedIn(){return!!this.token()}isAdmin(){return this.user()?.role==="admin"}waitForOAuthMessage(t){return new Promise((e,s)=>{let o=l=>{if(l.origin!==this.CLIENT_ORIGIN)return;let r=l.data;console.log("data",r),!(!r||!r.token||!r.user)&&(console.log(r),this.applyLogin({token:r.token,user:r.user}),a(),e())},i=setTimeout(()=>{a(),s(new Error("Temps d\xE9pass\xE9 lors de la connexion."))},6e4),a=()=>{window.removeEventListener("message",o),clearTimeout(i);try{t.close()}catch{}};window.addEventListener("message",o)})}applyLogin(t){this.token.set(t.token),this.user.set(t.user),localStorage.setItem("auth_token",t.token),localStorage.setItem("auth_user",JSON.stringify(t.user))}openOAuthPopup(t){let e=crypto.getRandomValues(new Uint32Array(4)).join("-"),s=`${t}?state=${encodeURIComponent(e)}`,o=520,i=620,a=window.top.outerHeight/2+window.top.screenY-i/2,l=window.top.outerWidth/2+window.top.screenX-o/2,r=window.open(s,"oauth_popup",`width=${o},height=${i},left=${l},top=${a},resizable=no,scrollbars=yes,status=no`);if(!r)throw new Error("Popup bloqu\xE9e par le navigateur.");return r}static \u0275fac=function(e){return new(e||u)};static \u0275prov=p({token:u,factory:u.\u0275fac,providedIn:"root"})};export{m as a};
