<section class="orders">
  <header class="head">
    <h2>Mes commandes</h2>
    <div class="tools">
      <select #s (change)="filterStatus(s.value)">
        <option value="">Tous statuts</option>
        <option value="pending">En attente</option>
        <option value="confirmed">Confirmée</option>
        <option value="shipped">Expédiée</option>
        <option value="delivered">Livrée</option>
        <option value="cancelled">Annulée</option>
      </select>
    </div>
  </header>

  <div *ngIf="loading()" class="loading">Chargement…</div>

  <!-- TABLE Desktop / CARDS Mobile -->
  <div class="table-wrap" *ngIf="!loading() && items().length">
    <!-- TABLE DESKTOP -->
    <table class="list hide-on-mobile">
      <thead>
      <tr>
        <th>Ref</th>
        <th>Date</th>
        <th>Articles</th>
        <th>Total</th>
        <th>Statut</th>
      </tr>
      </thead>
      <tbody>
      <tr
        *ngFor="let o of items(); trackBy: trackById"
        (click)="openDetails(o)"
        class="clickable-row"
      >
        <td>{{ o._id }}</td>
        <td>{{ o.createdAt | date: 'short' }}</td>
        <td>{{ o.items.length }}</td>
        <td>{{ o.total }} {{ o.currency }}</td>
        <td>
            <span class="badge" [ngClass]="o.status">
              {{ statusLabel(o.status) }}
            </span>
        </td>
      </tr>
      </tbody>
    </table>

    <!-- CARDS MOBILE -->
    <div class="cards only-mobile">
      <article
        class="card"
        *ngFor="let o of items(); trackBy: trackById"
        (click)="openDetails(o)"
      >
        <div class="row">
          <h3 class="ref">#{{ o._id }}</h3>
          <span class="badge" [ngClass]="o.status">
            {{ statusLabel(o.status) }}
          </span>
        </div>
        <div class="kv">
          <div>
            <dt>Date</dt>
            <dd>{{ o.createdAt | date: 'short' }}</dd>
          </div>
          <div>
            <dt>Articles</dt>
            <dd>{{ o.items.length }}</dd>
          </div>
          <div>
            <dt>Livraison</dt>
            <dd>{{ o.shippingFee }} {{ o.currency }}</dd>
          </div>
          <div>
            <dt>Total</dt>
            <dd class="total">{{ o.total }} {{ o.currency }}</dd>
          </div>
        </div>
      </article>
    </div>
  </div>

  <p *ngIf="!loading() && items().length === 0" class="empty">
    Aucune commande.
  </p>

  <div class="pager" *ngIf="pages() > 1">
    <button (click)="setPage(page() - 1)" [disabled]="page() === 1">‹</button>
    <span>Page {{ page() }} / {{ pages() }}</span>
    <button (click)="setPage(page() + 1)" [disabled]="page() === pages()">›</button>
  </div>
</section>

<!-- MODAL DÉTAIL COMMANDE -->
<div
  class="modal-backdrop"
  *ngIf="selectedOrder() as order"
  (click)="closeDetails()"
>
  <article class="modal" (click)="$event.stopPropagation()">
    <header class="modal-head">
      <div>
        <h3>Commande #{{ order._id }}</h3>
        <p class="modal-date">
          Passée le {{ order.createdAt | date: 'short' }}
        </p>
      </div>
      <button class="modal-close" (click)="closeDetails($event)">✕</button>
    </header>

    <section class="modal-status">
      <span class="badge" [ngClass]="order.status">
        {{ statusLabel(order.status) }}
      </span>
    </section>

    <section class="modal-summary">
      <div>
        <dt>Articles</dt>
        <dd>{{ order.items.length }}</dd>
      </div>
      <div>
        <dt>Livraison</dt>
        <dd>{{ order.shippingFee }} {{ order.currency }}</dd>
      </div>
      <div>
        <dt>Total</dt>
        <dd class="total">{{ order.total }} {{ order.currency }}</dd>
      </div>
    </section>

    <section class="modal-items">
      <h4>Produits</h4>
      <div class="modal-items-list">
        <!-- order.items: OrderItemInput[] -->
        <article class="modal-item" *ngFor="let it of order.items">
          <div class="modal-item-image">
            <img
              [src]="it.imageUrl || 'assets/images/placeholder-product.png'"
              [alt]="it.name"
            />
          </div>
          <div class="modal-item-info">
            <h5>{{ it.name }}</h5>

            <p class="line">
              Qté :
              <strong>{{ it.qty }}</strong>
            </p>

            <p class="line">
              Prix unitaire :
              <strong>{{ it.price }} {{ order.currency }}</strong>
            </p>

            <p class="line">
              Total ligne :
              <strong>{{ it.price * it.qty }} {{ order.currency }}</strong>
            </p>
          </div>
        </article>
      </div>
    </section>

    <footer class="modal-footer">
      <button class="modal-btn" (click)="closeDetails($event)">Fermer</button>
    </footer>
  </article>
</div>
