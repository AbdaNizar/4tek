<!-- Bouton utilisateur (si NON connecté) -->
<button
  *ngIf="!isLoggedIn(); else logged"
  class="user-btn"
  (click)="toggleModal()"
  aria-label="Se connecter / Créer un compte">
  <svg width="22" height="22" viewBox="0 0 24 24" fill="none" aria-hidden="true">
    <path d="M20 21a8 8 0 1 0-16 0" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
    <circle cx="12" cy="7" r="4" stroke="currentColor" stroke-width="2"/>
  </svg>
</button>

<!-- Bouton + menu (si connecté) -->
<ng-template #logged>
  <div class="user-chip"
       (click)="toggleUserMenu()"
       tabindex="0"
       aria-haspopup="menu"
       [attr.aria-expanded]="userMenuOpen()">
    <ng-container *ngIf="avatarUrlSafe() && hasAvatar(); else letter">
      <img
        [src]="avatarUrlSafe()!"
        alt="avatar"
        class="avatar-img"
        (error)="onAvatarError()"
        loading="lazy"
        referrerpolicy="no-referrer"
      />
    </ng-container>
    <ng-template #letter>
      <div class="avatar">{{ (shortName() | slice:0:1) | uppercase }}</div>
    </ng-template>
    <span class="name">{{ shortName() }}</span>
    <svg class="chev" width="16" height="16" viewBox="0 0 24 24">
      <path fill="currentColor" d="M7 10l5 5 5-5z"/>
    </svg>
  </div>

  <div class="user-menu" *ngIf="userMenuOpen()">

    <button type="button"  *ngIf="this.auth.user().role == 'user'" (click)="goToOrder()">Mes commandes</button>
    <button type="button"  *ngIf="this.auth.user().role == 'admin'" (click)="goToDashboard()"> Dashboard Admin</button>
    <button type="button" (click)="startForgot(auth.user()?.email || undefined)">Changer mon mot de passe</button>
    <button type="button" (click)="logout()">Se déconnecter</button>
  </div>
</ng-template>

<!-- Backdrop -->
<div class="modal-backdrop" *ngIf="open()" (click)="toggleModal()"></div>

<!-- Modal -->
<div
  class="modal"
  *ngIf="open()"
  [class.is-register]="mode()==='register'"
  role="dialog"
  aria-modal="true"
  aria-labelledby="authTitle">
  <div class="modal-panel">
    <div class="modal-head">
      <h3 id="authTitle">
        {{ mode() === 'login' ? 'Connexion'
        : mode() === 'register' ? 'Créer un compte'
        : mode() === 'verify-email' ? 'Confirme adresse email'
          : mode() === 'forgot' ? 'Mot de passe oublié'
            : 'Nouveau mot de passe' }}
      </h3>
      <button class="close" (click)="toggleModal()" aria-label="Fermer">×</button>
    </div>

    <form class="modal-body" [formGroup]="form" (ngSubmit)="submit()">
      <div class="fields">

        <!-- RESET -->
        <ng-container *ngIf="mode()==='reset'">
          <div class="field">
            <label>Nouveau mot de passe</label>
            <input #firstField type="password" formControlName="password" placeholder="••••••••" required minlength="6" />
          </div>
          <div class="field">
            <label>Confirmer le mot de passe</label>
            <input type="password" formControlName="confirm" placeholder="••••••••" required />
          </div>
        </ng-container>

        <!-- LOGIN -->
        <ng-container *ngIf="mode()==='login'">
          <div class="field">
            <label>Email</label>
            <input #firstField type="email" formControlName="email" placeholder="vous@exemple.tn" required />
          </div>
          <div class="field">
            <label>Mot de passe</label>
            <input type="password" formControlName="password" placeholder="••••••••" required minlength="6" />
            <button class="link small" type="button" (click)="startForgot(form.value.email || '')">
              Mot de passe oublié ?
            </button>
          </div>
        </ng-container>

        <!-- REGISTER -->
        <ng-container *ngIf="mode()==='register'">
          <div class="row-2">
            <div class="field">
              <label>Nom et Prénom</label>
              <input #firstField type="text" formControlName="name" placeholder="Nom et Prénom" required />
            </div>
            <div class="field">
              <label>Téléphone</label>
              <input type="tel" formControlName="phone" placeholder="+216 ..." />
            </div>
          </div>
          <div class="field">
            <label>Email</label>
            <input type="email" formControlName="email" placeholder="vous@exemple.tn" required />
          </div>
          <div class="row-2">
            <div class="field">
              <label>Mot de passe</label>
              <input type="password" formControlName="password" placeholder="••••••••" required minlength="6" />
            </div>
            <div class="field">
              <label>Confirmer le mot de passe</label>
              <input type="password" formControlName="confirm" placeholder="••••••••" required />
            </div>
          </div>
          <div class="field">
            <label>Adresse</label>
            <input type="text" formControlName="address" placeholder="Rue, ville..." />
          </div>
        </ng-container>

        <!-- FORGOT -->
        <ng-container *ngIf="mode()==='forgot'">
          <p class="muted">Saisis ton email, tu recevras un lien de réinitialisation.</p>
          <div class="field">
            <label>Email</label>
            <input #firstField type="email" formControlName="email" placeholder="vous@exemple.tn" required />
          </div>
        </ng-container>
        <!-- VERIFY-EMAIL -->
        <ng-container *ngIf="mode()==='verify-email'">
          <p class="muted">
            Ton compte n’est pas encore activé.<br>
            Entre ton email pour recevoir un nouveau lien de vérification.
          </p>
          <div class="field">
            <label>Email</label>
            <input type="email" formControlName="email" placeholder="vous@exemple.tn" required />
          </div>
        </ng-container>


        <!-- Messages -->
        <p class="notice-ok" *ngIf="okMsg()">{{ okMsg() }}</p>
        <p class="error" *ngIf="err()">{{ err() }}</p>

        <!-- CTA -->
        <button class="btn btn-primary w-full" type="submit" [disabled]="loading()">
          {{
            loading() ? 'Veuillez patienter…' :
              mode()==='login'    ? 'Se connecter' :
                mode()==='register' ? 'Créer le compte' :
                  mode()==='verify-email' ? 'Envoyer le lien' :
                  mode()==='forgot'   ? 'Envoyer le lien' :
                    'Changer le mot de passe'

          }}
        </button>

        <!-- Switch -->
        <div class="switch" *ngIf="mode()!=='forgot' && mode()!=='reset' && mode()!=='verify-email'">
          <ng-container *ngIf="mode() === 'login'; else regLink">
            Pas de compte ?
            <button class="link" type="button" (click)="switchMode('register')">Créer un compte</button>
          </ng-container>
          <ng-template #regLink>
            Déjà inscrit ?
            <button class="link" type="button" (click)="switchMode('login')">Se connecter</button>
          </ng-template>
        </div>

        <div class="switch" *ngIf="mode()==='forgot' && !auth.user()" >
          <button class="link" type="button" (click)="switchMode('login')">Retour à la connexion</button>
        </div>
      </div>

      <!-- Social (hors reset/forgot si tu veux) -->
      <div class="social" *ngIf="mode()!=='reset' && mode()!== 'verify-email' && !auth.user()  ">
        <button class="btn social-btn google" type="button" (click)="auth.startGoogleLogin()" aria-label="Se connecter avec Google">
  <span class="icon" aria-hidden="true">
    <svg viewBox="0 0 24 24" width="20" height="20" focusable="false">
      <!-- Google "G" logo (official 4-color mark) -->
      <path fill="#4285F4" d="M23.49 12.27c0-.78-.07-1.53-.2-2.27H12v4.29h6.44a5.52 5.52 0 0 1-2.39 3.62v3h3.87c2.26-2.08 3.57-5.15 3.57-8.64z"/>
      <path fill="#34A853" d="M12 24c3.24 0 5.96-1.07 7.95-2.91l-3.87-3a7.45 7.45 0 0 1-4.08 1.17c-3.13 0-5.78-2.11-6.73-4.96H1.26v3.12C3.23 21.3 7.3 24 12 24z"/>
      <path fill="#FBBC05" d="M5.27 14.29c-.24-.73-.38-1.51-.38-2.29s.14-1.56.38-2.29V6.59H1.26A11.98 11.98 0 0 0 0 12c0 1.94.46 3.77 1.26 5.41l4.01-3.12z"/>
      <path fill="#EA4335" d="M12 4.75c1.76 0 3.34.6 4.58 1.79l3.43-3.43C18-.02 15.24-1 12-1 7.3-1 3.23 1.7 1.26 6.59l4.01 3.12C6.22 6.86 8.87 4.75 12 4.75z"/>
    </svg>
  </span>
          <span>Google</span>
        </button>
        <!-- Ajouter un bouton Facebook à côté de Google -->
        <button class="btn social-btn facebook"
                type="button"
                (click)="auth.loginWithFacebook()"
                aria-label="Se connecter avec Facebook">
  <span class="icon" aria-hidden="true">
    <svg viewBox="0 0 24 24" width="20" height="20" focusable="false">
      <path fill="#fff" d="M22 12a10 10 0 1 0-11.563 9.875v-6.984H7.9V12h2.537V9.797c0-2.506 1.492-3.89 3.777-3.89 1.094 0 2.238.195 2.238.195v2.46h-1.26c-1.242 0-1.63.772-1.63 1.563V12h2.773l-.443 2.891h-2.33v6.984A10.001 10.001 0 0 0 22 12z"/>
    </svg>
  </span>
          <span>Facebook</span>
        </button>

      </div>
    </form>
  </div>
</div>
